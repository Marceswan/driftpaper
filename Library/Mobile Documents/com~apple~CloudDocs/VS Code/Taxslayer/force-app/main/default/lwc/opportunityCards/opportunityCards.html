<template>
    <!-- SINGLE MODE -->
    <template if:true={isSingleMode}>
        <lightning-card title="Opportunities" icon-name="standard:opportunity">
            <div slot="actions">
                <lightning-button-menu
                    alternative-text="Sort options"
                    icon-name="utility:sort"
                    onselect={handleSortChange}
                    menu-alignment="right"
                    class="slds-m-right_x-small">
                    <template for:each={sortOptions} for:item="option">
                        <lightning-menu-item
                            key={option.value}
                            value={option.value}
                            label={option.label}
                            checked={option.checked}>
                        </lightning-menu-item>
                    </template>
                </lightning-button-menu>
                <lightning-button-icon
                    icon-name="utility:refresh"
                    alternative-text="Refresh"
                    onclick={handleRefresh}
                    class="slds-m-right_x-small">
                </lightning-button-icon>
                <lightning-button-icon
                    icon-name="utility:add"
                    alternative-text="New Opportunity"
                    onclick={handleNew}>
                </lightning-button-icon>
            </div>

            <div class="slds-card__body slds-card__body_inner">
                <template if:true={isLoading}>
                    <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                </template>

                <template if:true={hasError}>
                    <div class="slds-text-color_error slds-p-around_medium">
                        <lightning-icon icon-name="utility:error" size="small" class="slds-m-right_x-small"></lightning-icon>
                        {errorMessage}
                    </div>
                </template>

                <template if:false={isLoading}>
                    <template if:false={hasError}>
                        <template if:true={hasOpportunities}>
                            <div class="cards-container">
                                <template for:each={allOpportunities} for:item="opp">
                                    <c-opportunity-card
                                        key={opp.id}
                                        opportunity={opp}
                                        highlight-fields={highlightFields}
                                        field-labels={fieldLabels}>
                                    </c-opportunity-card>
                                </template>
                            </div>
                            <template if:true={showViewAllSingle}>
                                <div class="slds-text-align_center slds-m-top_small">
                                    <lightning-button
                                        label={viewAllLabel}
                                        onclick={handleViewAll}
                                        variant="base">
                                    </lightning-button>
                                </div>
                            </template>
                        </template>
                        <template if:false={hasOpportunities}>
                            <div class="slds-text-align_center slds-p-around_medium slds-text-color_weak">
                                <p>No opportunities</p>
                                <lightning-button
                                    label="New Opportunity"
                                    onclick={handleNew}
                                    variant="neutral"
                                    class="slds-m-top_small">
                                </lightning-button>
                            </div>
                        </template>
                    </template>
                </template>
            </div>
        </lightning-card>
    </template>

    <!-- TABBED MODE -->
    <template if:true={isTabbedMode}>
        <lightning-card title="Opportunities" icon-name="standard:opportunity">
            <div slot="actions">
                <lightning-button-icon
                    icon-name="utility:refresh"
                    alternative-text="Refresh"
                    onclick={handleRefresh}
                    class="slds-m-right_x-small">
                </lightning-button-icon>
                <lightning-button-icon
                    icon-name="utility:add"
                    alternative-text="New Opportunity"
                    onclick={handleNew}>
                </lightning-button-icon>
            </div>

            <template if:true={isLoading}>
                <div class="slds-p-around_large">
                    <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                </div>
            </template>

            <template if:false={isLoading}>
                <lightning-tabset>
                    <lightning-tab label={openTabLabel}>
                        <div class="tab-actions slds-p-horizontal_medium slds-p-bottom_x-small">
                            <lightning-button-menu
                                alternative-text="Sort options"
                                icon-name="utility:sort"
                                onselect={handleOpenSortChange}
                                menu-alignment="right">
                                <template for:each={openSortOptions} for:item="option">
                                    <lightning-menu-item
                                        key={option.value}
                                        value={option.value}
                                        label={option.label}
                                        checked={option.checked}>
                                    </lightning-menu-item>
                                </template>
                            </lightning-button-menu>
                        </div>
                        <div class="slds-p-horizontal_medium">
                            <template if:true={hasOpenOpportunities}>
                                <template for:each={displayedOpenOpportunities} for:item="opp">
                                    <c-opportunity-card
                                        key={opp.id}
                                        opportunity={opp}
                                        highlight-fields={highlightFields}
                                        field-labels={fieldLabels}>
                                    </c-opportunity-card>
                                </template>
                                <template if:true={showViewAllOpen}>
                                    <div class="slds-text-align_center slds-m-top_small">
                                        <lightning-button
                                            label={viewAllOpenLabel}
                                            onclick={handleViewAllOpen}
                                            variant="base">
                                        </lightning-button>
                                    </div>
                                </template>
                            </template>
                            <template if:false={hasOpenOpportunities}>
                                <p class="slds-text-color_weak slds-text-align_center slds-p-around_medium">
                                    No open opportunities
                                </p>
                            </template>
                        </div>
                    </lightning-tab>
                    <lightning-tab label={closedTabLabel}>
                        <div class="tab-actions slds-p-horizontal_medium slds-p-bottom_x-small">
                            <lightning-button-menu
                                alternative-text="Sort options"
                                icon-name="utility:sort"
                                onselect={handleClosedSortChange}
                                menu-alignment="right">
                                <template for:each={closedSortOptions} for:item="option">
                                    <lightning-menu-item
                                        key={option.value}
                                        value={option.value}
                                        label={option.label}
                                        checked={option.checked}>
                                    </lightning-menu-item>
                                </template>
                            </lightning-button-menu>
                        </div>
                        <div class="slds-p-horizontal_medium">
                            <template if:true={hasClosedOpportunities}>
                                <template for:each={displayedClosedOpportunities} for:item="opp">
                                    <c-opportunity-card
                                        key={opp.id}
                                        opportunity={opp}
                                        highlight-fields={highlightFields}
                                        field-labels={fieldLabels}>
                                    </c-opportunity-card>
                                </template>
                                <template if:true={showViewAllClosed}>
                                    <div class="slds-text-align_center slds-m-top_small">
                                        <lightning-button
                                            label={viewAllClosedLabel}
                                            onclick={handleViewAllClosed}
                                            variant="base">
                                        </lightning-button>
                                    </div>
                                </template>
                            </template>
                            <template if:false={hasClosedOpportunities}>
                                <p class="slds-text-color_weak slds-text-align_center slds-p-around_medium">
                                    No closed opportunities
                                </p>
                            </template>
                        </div>
                    </lightning-tab>
                </lightning-tabset>
            </template>
        </lightning-card>
    </template>

    <!-- MULTI MODE -->
    <template if:true={isMultiMode}>
        <!-- Open Opportunities Section -->
        <lightning-card title="Open Opportunities" icon-name="standard:opportunity" class="slds-m-bottom_medium">
            <div slot="actions">
                <lightning-button-menu
                    alternative-text="Sort options"
                    icon-name="utility:sort"
                    onselect={handleOpenSortChange}
                    menu-alignment="right"
                    class="slds-m-right_x-small">
                    <template for:each={openSortOptions} for:item="option">
                        <lightning-menu-item
                            key={option.value}
                            value={option.value}
                            label={option.label}
                            checked={option.checked}>
                        </lightning-menu-item>
                    </template>
                </lightning-button-menu>
                <lightning-button-icon
                    icon-name="utility:refresh"
                    alternative-text="Refresh"
                    onclick={handleRefresh}
                    class="slds-m-right_x-small">
                </lightning-button-icon>
                <lightning-button-icon
                    icon-name="utility:add"
                    alternative-text="New Opportunity"
                    onclick={handleNew}>
                </lightning-button-icon>
            </div>
            <div class="slds-card__body slds-card__body_inner">
                <template if:true={isLoading}>
                    <lightning-spinner alternative-text="Loading" size="medium"></lightning-spinner>
                </template>
                <template if:false={isLoading}>
                    <template if:true={hasOpenOpportunities}>
                        <template for:each={displayedOpenOpportunities} for:item="opp">
                            <c-opportunity-card
                                key={opp.id}
                                opportunity={opp}
                                highlight-fields={highlightFields}
                                field-labels={fieldLabels}>
                            </c-opportunity-card>
                        </template>
                        <template if:true={showViewAllOpen}>
                            <div class="slds-text-align_center slds-m-top_small">
                                <lightning-button
                                    label={viewAllOpenLabel}
                                    onclick={handleViewAllOpenModal}
                                    variant="base">
                                </lightning-button>
                            </div>
                        </template>
                    </template>
                    <template if:false={hasOpenOpportunities}>
                        <p class="slds-text-color_weak slds-text-align_center slds-p-around_medium">
                            No open opportunities
                        </p>
                    </template>
                </template>
            </div>
        </lightning-card>

        <!-- Closed Opportunities Section -->
        <lightning-card title="Closed Opportunities" icon-name="standard:opportunity">
            <div slot="actions">
                <lightning-button-menu
                    alternative-text="Sort options"
                    icon-name="utility:sort"
                    onselect={handleClosedSortChange}
                    menu-alignment="right"
                    class="slds-m-right_x-small">
                    <template for:each={closedSortOptions} for:item="option">
                        <lightning-menu-item
                            key={option.value}
                            value={option.value}
                            label={option.label}
                            checked={option.checked}>
                        </lightning-menu-item>
                    </template>
                </lightning-button-menu>
                <lightning-button-icon
                    icon-name="utility:refresh"
                    alternative-text="Refresh"
                    onclick={handleRefresh}>
                </lightning-button-icon>
            </div>
            <div class="slds-card__body slds-card__body_inner">
                <template if:false={isLoading}>
                    <template if:true={hasClosedOpportunities}>
                        <template for:each={displayedClosedOpportunities} for:item="opp">
                            <c-opportunity-card
                                key={opp.id}
                                opportunity={opp}
                                highlight-fields={highlightFields}
                                field-labels={fieldLabels}>
                            </c-opportunity-card>
                        </template>
                        <template if:true={showViewAllClosed}>
                            <div class="slds-text-align_center slds-m-top_small">
                                <lightning-button
                                    label={viewAllClosedLabel}
                                    onclick={handleViewAllClosedModal}
                                    variant="base">
                                </lightning-button>
                            </div>
                        </template>
                    </template>
                    <template if:false={hasClosedOpportunities}>
                        <p class="slds-text-color_weak slds-text-align_center slds-p-around_medium">
                            No closed opportunities
                        </p>
                    </template>
                </template>
            </div>
        </lightning-card>
    </template>
</template>
